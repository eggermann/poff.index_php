# Poff File Browser

A single-file PHP file browser built from modular source files in `src/`.
It includes a viewer for common file types, per-folder/per-file config, and an MCP
endpoint used for helper routes like create, workprompt, edit-config, and prompt-template.

## What This App Does

- Browse folders and files with a sidebar tree.
- Render files in a viewer (images, video, audio, text, links, pdf, and other types).
- Store per-folder metadata in `poff.config.json` and per-file metadata in `.works/*.config.json`.
- Expose MCP routes for automation and edit mode.
- Provide an edit mode UI when `?edit=true` and a validation file exists.

## Project Layout

- `src/` - Source files (edit here).
  - `src/includes/` - Header, layout, scripts, viewer, and config helpers.
  - `src/mcp/` - MCP server + route handlers.
- `build/` - Build pipeline that concatenates `src` into a single `index.php`.
- `pages/` - Generated output (`pages/dominikeggermann.com/index.php`).
- `tests/` - MCP create-route tests and test fixtures.

Important: `pages/dominikeggermann.com/index.php` is generated. Do not edit it directly.

## Config Files

### `poff.config.json`
Stored in each folder, generated by `PoffConfig::ensure`.

Key fields:
- `folderName`, `slug`, `title`, `description`
- `tree`: first-level items with `visible` flags
- `work`: per-folder work metadata
  - `work.layout` can be a string or object
  - `work.layout.template` is used by prompt editing

### `.works/{filename}.config.json`
Per-file config, stored next to files inside `.works/`.

### `poff.config.toon`
Written by MCP for workspace tree snapshots (used by MCP info routes).

## Edit Mode (Fake Login)

Edit mode is enabled when:
1) A file named `.edit.allow` exists in the site root, and
2) The URL includes `?edit=true`.

Edit mode UI:
- Inline edits: title + description (in-place, with Save).
- "More..." drawer: link, url, work type, work layout, tree visibility.
- Prompt window: generates and saves `work.layout.template`.

Edits are saved through MCP `route=edit-config`.

## Prompt Window (Template Generation)

Providers:
- `local` (custom HTTP endpoint)
- `openai`
- `gemini`

API key sources:
- `.env` (`OPENAI_API_KEY`, `GEMINI_API_KEY`)
- or browser localStorage (set in the edit UI)

Local endpoint payload:
```json
{
  "prompt": "string",
  "history": [{ "role": "user|assistant", "content": "..." }],
  "config": { ...full poff.config.json... },
  "instruction": "string"
}
```

Expected local response:
- JSON with `{ "template": "..." }`, or
- a plain text body (used as template).

Templates are saved into `work.layout.template` via MCP `route=edit-config`.

## MCP Routes

The MCP server lives at `src/mcp/server.php` and can be called via:
`index.php?mcp=1&route=...` (when built) or directly at `/src/mcp/server.php`.

Routes:
- `info` (default): returns config + tree info
- `create`: create folders or copy content into a destination
- `workprompt`: prepare a work prompt and template for a file
- `style`: simple echo route for styling prompts
- `edit-config`: read/write `poff.config.json` for the current folder
- `prompt-template`: call local/OpenAI/Gemini to generate `work.layout.template`

### MCP Examples

Fetch MCP info:
```sh
curl "http://localhost/your-index.php?mcp=1"
```

Create a destination folder under `poff`:
```sh
curl "http://localhost/your-index.php?mcp=1&route=create&dest=demo-folder"
```

Copy from a path under `/poff`:
```sh
curl "http://localhost/your-index.php?mcp=1&route=create&dest=demo-copy&path=datas"
```

Workprompt for a file:
```sh
curl "http://localhost/your-index.php?mcp=1&route=workprompt&file=folder/file.jpg&style=Bold%20layout"
```

Read folder config via edit-config:
```sh
curl "http://localhost/your-index.php?mcp=1&route=edit-config&path=some-folder"
```

Save config updates:
```sh
curl -X POST "http://localhost/your-index.php?mcp=1&route=edit-config&path=some-folder" \
  -H "Content-Type: application/json" \
  -d '{"title":"New title","description":"Updated","layout":{"mode":"grid","template":"..."},"treeVisible":["index.php"]}'
```

Generate a template via prompt-template (local endpoint):
```sh
curl -X POST "http://localhost/your-index.php?mcp=1&route=prompt-template&path=some-folder" \
  -H "Content-Type: application/json" \
  -d '{"provider":"local","endpoint":"http://localhost:1234/generate","prompt":"Create a card layout"}'
```

## Build Process

Source is compiled into a single PHP file:
- Build script: `build/build.php`
- Config: `build/BuildConfig.php`
- Output: `pages/dominikeggermann.com/index.php`

Manual build:
```sh
php build/build.php
```

Auto build:
- The watcher script is `scripts/watch-build.js`.
- If your `package.json` includes the watch script, run `npm run watch`.
- Otherwise run:
```sh
node scripts/watch-build.js
```

The watcher rebuilds on changes and optionally refreshes a browser tab when running under MAMP.

## Tests

Run MCP create-route tests:
```sh
npm run test:mcp
```

## Development Notes

- Edit only files in `src/`; rebuild to update `pages/`.
- `PoffConfig` merges new tree data while preserving custom fields.
- The edit UI uses localStorage for prompt settings; remove to reset.

## Local Prompt Endpoint Schema

If you use a custom local endpoint, implement a handler that accepts:
```json
{
  "prompt": "string",
  "history": [{ "role": "user|assistant", "content": "..." }],
  "config": { ...full poff.config.json... },
  "instruction": "string"
}
```

Responses:
- JSON `{ "template": "<html>...</html>" }`, or
- plain text (the body becomes the template).

## Deployment

1) Run the build.
2) Deploy the generated `index.php` and required assets.
3) Ensure PHP has read/write access where configs are stored.
